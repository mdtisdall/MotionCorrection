#ifndef TricubicInterpolator_h
#define TricubicInterpolator_h

#include "Interpolator3D.h"

#include <stdio.h>
#include <iostream>
#include <fstream>
#include <Eigen/Dense>
#include <vector>
using namespace Eigen;
using namespace std;

template <
    typename VolumeT,
    typename coordT>
class TricubicInterpolator :
    public Interpolator3D<VolumeT, coordT> {

  public:
    typedef typename VolumeT::T T;
    typedef Matrix< float, Dynamic, Dynamic >  MatrixXT;
    typedef Matrix< float, Dynamic, 1 >     VectorXT;
    typedef Matrix< float, 1, Dynamic >     RowVectorXT;
    int derives_shape;
    MatrixXT generate_X_inv(){
        MatrixXT X_inv(64,64);
        X_inv << 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -3, 3, 0, 0, 0, 0, 0, 0,-2,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 2,-2, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 9,-9,-9, 9, 0, 0, 0, 0, 6, 3,-6,-3, 0, 0, 0, 0, 6,-6, 3,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -6, 6, 6,-6, 0, 0, 0, 0,-3,-3, 3, 3, 0, 0, 0, 0,-4, 4,-2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-2,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -6, 6, 6,-6, 0, 0, 0, 0,-4,-2, 4, 2, 0, 0, 0, 0,-3, 3,-3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-1,-2,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 4,-4,-4, 4, 0, 0, 0, 0, 2, 2,-2,-2, 0, 0, 0, 0, 2,-2, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 3, 0, 0, 0, 0, 0, 0,-2,-1, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9,-9,-9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3,-6,-3, 0, 0, 0, 0, 6,-6, 3,-3, 0, 0, 0, 0, 4, 2, 2, 1, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-6, 6, 6,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3,-3, 3, 3, 0, 0, 0, 0,-4, 4,-2, 2, 0, 0, 0, 0,-2,-2,-1,-1, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-6, 6, 6,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4,-2, 4, 2, 0, 0, 0, 0,-3, 3,-3, 3, 0, 0, 0, 0,-2,-1,-2,-1, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,-4,-4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2,-2,-2, 0, 0, 0, 0, 2,-2, 2,-2, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0,
                -3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 9,-9, 0, 0,-9, 9, 0, 0, 6, 3, 0, 0,-6,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,-6, 0, 0, 3,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 2, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -6, 6, 0, 0, 6,-6, 0, 0,-3,-3, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4, 4, 0, 0,-2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-2, 0, 0,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0, 0, 0,-1, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9,-9, 0, 0,-9, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 3, 0, 0,-6,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6,-6, 0, 0, 3,-3, 0, 0, 4, 2, 0, 0, 2, 1, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-6, 6, 0, 0, 6,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3,-3, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4, 4, 0, 0,-2, 2, 0, 0,-2,-2, 0, 0,-1,-1, 0, 0,
                 9, 0,-9, 0,-9, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 3, 0,-6, 0,-3, 0, 6, 0,-6, 0, 3, 0,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 2, 0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 9, 0,-9, 0,-9, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 3, 0,-6, 0,-3, 0, 6, 0,-6, 0, 3, 0,-3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 2, 0, 2, 0, 1, 0,
                -27,27,27,-27,27,-27,-27,27,-18,-9,18, 9,18, 9,-18,-9,-18,18,-9, 9,18,-18, 9,-9,-18,18,18,-18,-9, 9, 9,-9,-12,-6,-6,-3,12, 6, 6, 3,-12,-6,12, 6,-6,-3, 6, 3,-12,12,-6, 6,-6, 6,-3, 3,-8,-4,-4,-2,-4,-2,-2,-1,
                18,-18,-18,18,-18,18,18,-18, 9, 9,-9,-9,-9,-9, 9, 9,12,-12, 6,-6,-12,12,-6, 6,12,-12,-12,12, 6,-6,-6, 6, 6, 6, 3, 3,-6,-6,-3,-3, 6, 6,-6,-6, 3, 3,-3,-3, 8,-8, 4,-4, 4,-4, 2,-2, 4, 4, 2, 2, 2, 2, 1, 1,
                -6, 0, 6, 0, 6, 0,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0,-3, 0, 3, 0, 3, 0,-4, 0, 4, 0,-2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-2, 0,-1, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0,-6, 0, 6, 0, 6, 0,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 0,-3, 0, 3, 0, 3, 0,-4, 0, 4, 0,-2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-2, 0,-1, 0,-1, 0,
                18,-18,-18,18,-18,18,18,-18,12, 6,-12,-6,-12,-6,12, 6, 9,-9, 9,-9,-9, 9,-9, 9,12,-12,-12,12, 6,-6,-6, 6, 6, 3, 6, 3,-6,-3,-6,-3, 8, 4,-8,-4, 4, 2,-4,-2, 6,-6, 6,-6, 3,-3, 3,-3, 4, 2, 4, 2, 2, 1, 2, 1,
                -12,12,12,-12,12,-12,-12,12,-6,-6, 6, 6, 6, 6,-6,-6,-6, 6,-6, 6, 6,-6, 6,-6,-8, 8, 8,-8,-4, 4, 4,-4,-3,-3,-3,-3, 3, 3, 3, 3,-4,-4, 4, 4,-2,-2, 2, 2,-4, 4,-4, 4,-2, 2,-2, 2,-2,-2,-2,-2,-1,-1,-1,-1,
                 2, 0, 0, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                -6, 6, 0, 0, 6,-6, 0, 0,-4,-2, 0, 0, 4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 3, 0, 0,-3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2,-1, 0, 0,-2,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 4,-4, 0, 0,-4, 4, 0, 0, 2, 2, 0, 0,-2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-6, 6, 0, 0, 6,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4,-2, 0, 0, 4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-3, 3, 0, 0,-3, 3, 0, 0,-2,-1, 0, 0,-2,-1, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4,-4, 0, 0,-4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0,-2,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2,-2, 0, 0, 2,-2, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0,
                -6, 0, 6, 0, 6, 0,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4, 0,-2, 0, 4, 0, 2, 0,-3, 0, 3, 0,-3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0,-2, 0,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0,-6, 0, 6, 0, 6, 0,-6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-4, 0,-2, 0, 4, 0, 2, 0,-3, 0, 3, 0,-3, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0,-2, 0,-1, 0,-2, 0,-1, 0,
                18,-18,-18,18,-18,18,18,-18,12, 6,-12,-6,-12,-6,12, 6,12,-12, 6,-6,-12,12,-6, 6, 9,-9,-9, 9, 9,-9,-9, 9, 8, 4, 4, 2,-8,-4,-4,-2, 6, 3,-6,-3, 6, 3,-6,-3, 6,-6, 3,-3, 6,-6, 3,-3, 4, 2, 2, 1, 4, 2, 2, 1,
                -12,12,12,-12,12,-12,-12,12,-6,-6, 6, 6, 6, 6,-6,-6,-8, 8,-4, 4, 8,-8, 4,-4,-6, 6, 6,-6,-6, 6, 6,-6,-4,-4,-2,-2, 4, 4, 2, 2,-3,-3, 3, 3,-3,-3, 3, 3,-4, 4,-2, 2,-4, 4,-2, 2,-2,-2,-1,-1,-2,-2,-1,-1,
                 4, 0,-4, 0,-4, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0,-2, 0,-2, 0, 2, 0,-2, 0, 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                 0, 0, 0, 0, 0, 0, 0, 0, 4, 0,-4, 0,-4, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0,-2, 0,-2, 0, 2, 0,-2, 0, 2, 0,-2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0,
                -12,12,12,-12,12,-12,-12,12,-8,-4, 8, 4, 8, 4,-8,-4,-6, 6,-6, 6, 6,-6, 6,-6,-6, 6, 6,-6,-6, 6, 6,-6,-4,-2,-4,-2, 4, 2, 4, 2,-4,-2, 4, 2,-4,-2, 4, 2,-3, 3,-3, 3,-3, 3,-3, 3,-2,-1,-2,-1,-2,-1,-2,-1,
                 8,-8,-8, 8,-8, 8, 8,-8, 4, 4,-4,-4,-4,-4, 4, 4, 4,-4, 4,-4,-4, 4,-4, 4, 4,-4,-4, 4, 4,-4,-4, 4, 2, 2, 2, 2,-2,-2,-2,-2, 2, 2,-2,-2, 2, 2,-2,-2, 2,-2, 2,-2, 2,-2, 2,-2, 1, 1, 1, 1, 1, 1, 1, 1;
        return X_inv;
    }
    TricubicInterpolator(const VolumeT *volume) :
        Interpolator3D<VolumeT, coordT>(volume),
        X_inv(generate_X_inv()),
        derives_shape(volume->cubeSize+30),
        derivatives(derives_shape * derives_shape * derives_shape){
            int shape = volume->cubeSize;

            // a vector used to temporary store the polynomials of x, y, and z 
            VectorXT Y(64);

            for(int z = 0; z < derives_shape; ++z){
                for(int y = 0; y < derives_shape; ++y){
                    for(int x = 0; x < derives_shape; ++x){
                        int z1 = x - 15;
                        int y1 = y - 15;
                        int x1 = z - 15;
                        
                        int x0 = x1 - 1;
                        int x2 = x1 + 1;
                        int x3 = x2 + 1;
                        int y0 = y1 - 1;
                        int y2 = y1 + 1;
                        int y3 = y2 + 1;
                        int z0 = z1 - 1;
                        int z2 = z1 + 1;
                        int z3 = z2 + 1;

                        //Wrap Around
                        x0 = (x0 + shape) % shape;
                        x1 = (x1 + shape) % shape;
                        x2 = (x2 + shape) % shape;
                        x3 = (x3 + shape) % shape;

                        y0 = (y0 + shape) % shape;
                        y1 = (y1 + shape) % shape;
                        y2 = (y2 + shape) % shape;
                        y3 = (y3 + shape) % shape;

                        z0 = (z0 + shape) % shape;
                        z1 = (z1 + shape) % shape;
                        z2 = (z2 + shape) % shape;
                        z3 = (z3 + shape) % shape;                    

                        //values of f(x,y,z) at each corner.
                        Y(0)= this->volume->at(z1, y1, x1);
                        Y(1)= this->volume->at(z2, y1, x1);
                        Y(2)= this->volume->at(z1, y1, x2);
                        Y(3)= this->volume->at(z2, y1, x2);
                        Y(4)= this->volume->at(z1, y2, x1);
                        Y(5)= this->volume->at(z2, y2, x1);
                        Y(6)= this->volume->at(z1, y2, x2);
                        Y(7)= this->volume->at(z2, y2, x2);

                        //values of df/dx
                        Y(8)= ((this->volume->at(z2, y1, x1)-this->volume->at(z0, y1, x1))/2.);
                        Y(9)= ((this->volume->at(z3, y1, x1)-this->volume->at(z1, y1, x1))/2.);
                        Y(10) = ((this->volume->at(z2, y1, x2)-this->volume->at(z0, y1, x2))/2.);
                        Y(11) = ((this->volume->at(z3, y1, x2)-this->volume->at(z1, y1, x2))/2.);
                        Y(12) = ((this->volume->at(z2, y2, x1)-this->volume->at(z0, y2, x1))/2.);
                        Y(13) = ((this->volume->at(z3, y2, x1)-this->volume->at(z1, y2, x1))/2.);
                        Y(14) = ((this->volume->at(z2, y2, x2)-this->volume->at(z0, y2, x2))/2.);
                        Y(15) = ((this->volume->at(z3, y2, x2)-this->volume->at(z1, y2, x2))/2.);

                        //values of df/dy
                        Y(16) = ((this->volume->at(z1, y1, x2)-this->volume->at(z1, y1, x0))/2.);
                        Y(17) = ((this->volume->at(z2, y1, x2)-this->volume->at(z2, y1, x0))/2.);
                        Y(18) = ((this->volume->at(z1, y1, x3)-this->volume->at(z1, y1, x1))/2.);
                        Y(19) = ((this->volume->at(z2, y1, x3)-this->volume->at(z2, y1, x1))/2.);
                        Y(20) = ((this->volume->at(z1, y2, x2)-this->volume->at(z1, y2, x0))/2.);
                        Y(21) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y2, x0))/2.);
                        Y(22) = ((this->volume->at(z1, y2, x3)-this->volume->at(z1, y2, x1))/2.);
                        Y(23) = ((this->volume->at(z2, y2, x3)-this->volume->at(z2, y2, x1))/2.);

                        //values of df/df
                        Y(24) = ((this->volume->at(z1, y2, x1)-this->volume->at(z1, y0, x1))/2.);
                        Y(25) = ((this->volume->at(z2, y2, x1)-this->volume->at(z2, y0, x1))/2.);
                        Y(26) = ((this->volume->at(z1, y2, x2)-this->volume->at(z1, y0, x2))/2.);
                        Y(27) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y0, x2))/2.);
                        Y(28) = ((this->volume->at(z1, y3, x1)-this->volume->at(z1, y1, x1))/2.);
                        Y(29) = ((this->volume->at(z2, y3, x1)-this->volume->at(z2, y1, x1))/2.);
                        Y(30) = ((this->volume->at(z1, y3, x2)-this->volume->at(z1, y1, x2))/2.);
                        Y(31) = ((this->volume->at(z2, y3, x2)-this->volume->at(z2, y1, x2))/2.);

                        //values of d2f/dxdy
                        Y(32) = ((this->volume->at(z2, y1, x2)-this->volume->at(z2, y1, x0)-this->volume->at(z0, y1, x2)+this->volume->at(z0, y1, x0))/4.);
                        Y(33) = ((this->volume->at(z3, y1, x2)-this->volume->at(z3, y1, x0)-this->volume->at(z1, y1, x2)+this->volume->at(z1, y1, x0))/4.);
                        Y(34) = ((this->volume->at(z2, y1, x3)-this->volume->at(z2, y1, x1)-this->volume->at(z0, y1, x3)+this->volume->at(z0, y1, x1))/4.);
                        Y(35) = ((this->volume->at(z3, y1, x3)-this->volume->at(z3, y1, x1)-this->volume->at(z1, y1, x3)+this->volume->at(z1, y1, x1))/4.);
                        Y(36) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y2, x0)-this->volume->at(z0, y2, x2)+this->volume->at(z0, y2, x0))/4.);
                        Y(37) = ((this->volume->at(z3, y2, x2)-this->volume->at(z3, y2, x0)-this->volume->at(z1, y2, x2)+this->volume->at(z1, y2, x0))/4.);
                        Y(38) = ((this->volume->at(z2, y2, x3)-this->volume->at(z2, y2, x1)-this->volume->at(z0, y2, x3)+this->volume->at(z0, y2, x1))/4.);
                        Y(39) = ((this->volume->at(z3, y2, x3)-this->volume->at(z3, y2, x1)-this->volume->at(z1, y2, x3)+this->volume->at(z1, y2, x1))/4.);

                        //values of d2f/dxdf
                        Y(40) = ((this->volume->at(z2, y2, x1)-this->volume->at(z2, y0, x1)-this->volume->at(z0, y2, x1)+this->volume->at(z0, y0, x1))/4.);
                        Y(41) = ((this->volume->at(z3, y2, x1)-this->volume->at(z3, y0, x1)-this->volume->at(z1, y2, x1)+this->volume->at(z1, y0, x1))/4.);
                        Y(42) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y0, x2)-this->volume->at(z0, y2, x2)+this->volume->at(z0, y0, x2))/4.);
                        Y(43) = ((this->volume->at(z3, y2, x2)-this->volume->at(z3, y0, x2)-this->volume->at(z1, y2, x2)+this->volume->at(z1, y0, x2))/4.);
                        Y(44) = ((this->volume->at(z2, y3, x1)-this->volume->at(z2, y1, x1)-this->volume->at(z0, y3, x1)+this->volume->at(z0, y1, x1))/4.);
                        Y(45) = ((this->volume->at(z3, y3, x1)-this->volume->at(z3, y1, x1)-this->volume->at(z1, y3, x1)+this->volume->at(z1, y1, x1))/4.);
                        Y(46) = ((this->volume->at(z2, y3, x2)-this->volume->at(z2, y1, x2)-this->volume->at(z0, y3, x2)+this->volume->at(z0, y1, x2))/4.);
                        Y(47) = ((this->volume->at(z3, y3, x2)-this->volume->at(z3, y1, x2)-this->volume->at(z1, y3, x2)+this->volume->at(z1, y1, x2))/4.);

                        //values of d2f/dydf
                        Y(48) = ((this->volume->at(z1, y2, x2)-this->volume->at(z1, y2, x0)-this->volume->at(z1, y0, x2)+this->volume->at(z1, y0, x0))/4.);
                        Y(49) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y2, x0)-this->volume->at(z2, y0, x2)+this->volume->at(z2, y0, x0))/4.);
                        Y(50) = ((this->volume->at(z1, y2, x3)-this->volume->at(z1, y2, x1)-this->volume->at(z1, y0, x3)+this->volume->at(z1, y0, x1))/4.);
                        Y(51) = ((this->volume->at(z2, y2, x3)-this->volume->at(z2, y2, x1)-this->volume->at(z2, y0, x3)+this->volume->at(z2, y0, x1))/4.);
                        Y(52) = ((this->volume->at(z1, y3, x2)-this->volume->at(z1, y3, x0)-this->volume->at(z1, y1, x2)+this->volume->at(z1, y1, x0))/4.);
                        Y(53) = ((this->volume->at(z2, y3, x2)-this->volume->at(z2, y3, x0)-this->volume->at(z2, y1, x2)+this->volume->at(z2, y1, x0))/4.);
                        Y(54) = ((this->volume->at(z1, y3, x3)-this->volume->at(z1, y3, x1)-this->volume->at(z1, y1, x3)+this->volume->at(z1, y1, x1))/4.);
                        Y(55) = ((this->volume->at(z2, y3, x3)-this->volume->at(z2, y3, x1)-this->volume->at(z2, y1, x3)+this->volume->at(z2, y1, x1))/4.);

                        //values of d3f/dxdydf
                        Y(56) = ((this->volume->at(z2, y2, x2)-this->volume->at(z2, y2, x0)-this->volume->at(z0, y2, x2)+this->volume->at(z0, y2, x0))
                                  -(this->volume->at(z2, y0, x2)-this->volume->at(z2, y0, x0)-this->volume->at(z0, y0, x2)+this->volume->at(z0, y0, x0)))/8.;
                        Y(57) = ((this->volume->at(z3, y2, x2)-this->volume->at(z3, y2, x0)-this->volume->at(z1, y2, x2)+this->volume->at(z1, y2, x0))
                                  -(this->volume->at(z3, y0, x2)-this->volume->at(z3, y0, x0)-this->volume->at(z1, y0, x2)+this->volume->at(z1, y0, x0)))/8.;
                        Y(58) = ((this->volume->at(z2, y2, x3)-this->volume->at(z2, y2, x1)-this->volume->at(z0, y2, x3)+this->volume->at(z0, y2, x1))
                                  -(this->volume->at(z2, y0, x3)-this->volume->at(z2, y0, x1)-this->volume->at(z0, y0, x3)+this->volume->at(z0, y0, x1)))/8.;
                        Y(59) = ((this->volume->at(z3, y2, x3)-this->volume->at(z3, y2, x1)-this->volume->at(z1, y2, x3)+this->volume->at(z1, y2, x1))
                                  -(this->volume->at(z3, y0, x3)-this->volume->at(z3, y0, x1)-this->volume->at(z1, y0, x3)+this->volume->at(z1, y0, x1)))/8.;

                        Y(60) = ((this->volume->at(z2, y3, x2)-this->volume->at(z2, y3, x0)-this->volume->at(z0, y3, x2)+this->volume->at(z0, y3, x0))
                                  -(this->volume->at(z2, y1, x2)-this->volume->at(z2, y1, x0)-this->volume->at(z0, y1, x2)+this->volume->at(z0, y1, x0)))/8.;
                        Y(61) = ((this->volume->at(z3, y3, x2)-this->volume->at(z3, y3, x0)-this->volume->at(z1, y3, x2)+this->volume->at(z1, y3, x0))
                                  -(this->volume->at(z3, y1, x2)-this->volume->at(z3, y1, x0)-this->volume->at(z1, y1, x2)+this->volume->at(z1, y1, x0)))/8.;
                        Y(62) = ((this->volume->at(z2, y3, x3)-this->volume->at(z2, y3, x1)-this->volume->at(z0, y3, x3)+this->volume->at(z0, y3, x1))
                                  -(this->volume->at(z2, y1, x3)-this->volume->at(z2, y1, x1)-this->volume->at(z0, y1, x3)+this->volume->at(z0, y1, x1)))/8.;
                        Y(63) = ((this->volume->at(z3, y3, x3)-this->volume->at(z3, y3, x1)-this->volume->at(z1, y3, x3)+this->volume->at(z1, y3, x1))
                                  -(this->volume->at(z3, y1, x3)-this->volume->at(z3, y1, x1)-this->volume->at(z1, y1, x3)+this->volume->at(z1, y1, x1)))/8.;

                        // compute the index to the derivatives vector from loop indicies i, j and k
                        int idx = derives_shape * (derives_shape * y + x) + z;
                        // cout << "idx: " << idx << endl;
                        // store the derivatives
                        derivatives[idx] = X_inv*Y;
                    }
                }
            }
        }

    static void get_target_Y(RowVectorXT *Y, float z, float y, float x){
        (*Y)(0) = float(1.0);
        (*Y)(1) = x;
        (*Y)(2) = x*x;
        (*Y)(3) = x*x*x;
        (*Y)(4) = y;
        (*Y)(5) = x*y;
        (*Y)(6) = x*x*y;
        (*Y)(7) = x*x*x*y;
        (*Y)(8) = y*y;
        (*Y)(9) = x*y*y;
        (*Y)(10) = x*x*y*y;
        (*Y)(11) = x*x*x*y*y;
        (*Y)(12) = y*y*y;
        (*Y)(13) = x*y*y*y;
        (*Y)(14) = x*x*y*y*y;
        (*Y)(15) = x*x*x*y*y*y;
        

        (*Y)(16) = z;
        (*Y)(17) = x*z;
        (*Y)(18) = x*x*z;
        (*Y)(19) = x*x*x*z;
        (*Y)(20) = y*z;
        (*Y)(21) = x*y*z;
        (*Y)(22) = x*x*y*z;
        (*Y)(23) = x*x*x*y*z;
        (*Y)(24) = y*y*z;
        (*Y)(25) = x*y*y*z;
        (*Y)(26) = x*x*y*y*z;
        (*Y)(27) = x*x*x*y*y*z;
        (*Y)(28) = y*y*y*z;
        (*Y)(29) = x*y*y*y*z;
        (*Y)(30) = x*x*y*y*y*z;
        (*Y)(31) = x*x*x*y*y*y*z;

        (*Y)(32) = z*z;
        (*Y)(33) = x*z*z;
        (*Y)(34) = x*x*z*z;
        (*Y)(35) = x*x*x*z*z;
        (*Y)(36) = y*z*z;
        (*Y)(37) = x*y*z*z;
        (*Y)(38) = x*x*y*z*z;
        (*Y)(39) = x*x*x*y*z*z;
        (*Y)(40) = y*y*z*z;
        (*Y)(41) = x*y*y*z*z;
        (*Y)(42) = x*x*y*y*z*z;
        (*Y)(43) = x*x*x*y*y*z*z;
        (*Y)(44) = y*y*y*z*z;
        (*Y)(45) = x*y*y*y*z*z;
        (*Y)(46) = x*x*y*y*y*z*z;
        (*Y)(47) = x*x*x*y*y*y*z*z;

        (*Y)(48) = z*z*z;
        (*Y)(49) = x*z*z*z;
        (*Y)(50) = x*x*z*z*z;
        (*Y)(51) = x*x*x*z*z*z;
        (*Y)(52) = y*z*z*z;
        (*Y)(53) = x*y*z*z*z;
        (*Y)(54) = x*x*y*z*z*z;
        (*Y)(55) = x*x*x*y*z*z*z;
        (*Y)(56) = y*y*z*z*z;
        (*Y)(57) = x*y*y*z*z*z;
        (*Y)(58) = x*x*y*y*z*z*z;
        (*Y)(59) = x*x*x*y*y*z*z*z;
        (*Y)(60) = y*y*y*z*z*z;
        (*Y)(61) = x*y*y*y*z*z*z;
        (*Y)(62) = x*x*y*y*y*z*z*z;
        (*Y)(63) = x*x*x*y*y*y*z*z*z;
    }

    virtual T interp(
        const coordT z,
        const coordT y,
        const coordT x) const {

        int x1 = z;
        int y1 = y;
        int z1 = x;

        RowVectorXT target_Y(64);
        get_target_Y(&target_Y, y-y1, x-z1, z-x1);
        return (target_Y * derivatives[derives_shape * (derives_shape*(y1+15) + (x1+15)) + (z1+15)]).value();
    }
  protected:
    const MatrixXT X_inv;
    std::vector<MatrixXT> derivatives;
};

#endif
